## Async await



## Introduction

- sugar syntax for combination of generators and promises (with ES2017)
- solves problems of Promises üéâ



## Generators and Promises

- generator function that yields promises (pauses)
- outside pulls promise out, waits for promise to resolve, pushes result back in as value or error
- iterator is iterated asynchronously since promise handler runs asynchronously
- wrap the supposed promise in `Promise.resolve()` to make sure it's a promise and always asynchronous

```javascript
function* gen() {
    const a = 21;
    const val = yield somePromise(); // or yield* if another iterator
    const b = a * val;
    return b;
}

const it = gen();

const {value, _} = it.next();

Promise.resolve(value)
  .then(val => it.next(val), err => it.throw(err))
  .then(.., ..)
```

- generator looks like function that pauses and resumes where it left off *asynchronously*, waiting for the yielded promise to settle, then continuing with its value if it fulfilled or throwing the error if it rejected
- the code block after a `yield` effectively becomes the handler of the promise it yielded since it's passed the result
- multiple handler look like one code block, no promise chain üéâ
- handler can access state from previous handlers since generator keeps shared state üéâ
- gets back `try...catch` üéâ
- can safely `yield` (and `return` and `throw`) any value, since is wrapped as a promise with `Promise.resolve()`
- last promise settles with return value or uncaught error thrown



- beware: `return`ing a promise instead of `return yield`ing it doesn't wait for it to settle, little difference when it fulfills, but if it rejects can't catch it in `try...catch` inside ‚ùóÔ∏è



## Driver

helper function to recursively resolve promises
manually iterating the iterator, pulling promises resolving and pushing back in is cumbersome
needs to adapt if there are multiple promises

- above only works for a generator which yields a single promise
- repeat iteration control until all promises are resolved
- put iteration control into own function
- returns itself a promise for the completion of the generator with the last resolved value
- can think of as a driver, repeatedly continues generator until receives last promise
- beware: can not pause driver in between `yield`s unlike when driven manually ‚ùóÔ∏è
looks like generator pauses, but driver drives it continuously, can't stop ‚ùóÔ∏è


```javascript
function spawn(gen, ...args) {
  const it = gen(...args);
  return new Promise((res, rej) => {

    (function pushBackIn(val, err) {
      try {
        // in first recursion is `it.next()` since both `val` and `err` are `undefined`
        const { value, done } = err ? it.throw(err) : it.next(val);

        if (done) {
          res(value);
        } else {
          Promise.resolve(value).then(val => pushBackIn(val, undefined), err => pushBackIn(undefined, err));
        }
      } catch (err) {
        rej(err);
      }
    })();

  });
}

spawn(gen).then(.., ..)
```



## Async await

- sugar that abstracts away driver of generator

async func: is generator which yields promises, called normally, behind the scenes passed to a spawn function, passed to a driver

- calls async function instead of generator, uses `async function` instead of `function*` and `await` instead of `yield`(`*`)
- calls async function directly instead of driver with generator
- beware: can use async function as arrow function, unlike generator yet as of 2021 ‚ùóÔ∏è

```javascript
function* gen() {
    console.log("start");
    const val = yield somePromise(); // or yield* if it's another generator
    console.log("end");
    return val;
}

spawn(gen).then(.., ..);

async function new() {
    console.log("start");
    const val = await somePromise();
    console.log("end");
    return val;
}

new().then(.., ..);
```



## Top-level await

- await in top-level of module
- module is treated as if it were within an async function
- beware: takes at least one trip through the microtask queue before it's run ‚ùóÔ∏è



## Resources

- [Jake Archibald - await vs return vs return await](https://jakearchibald.com/2017/await-vs-return-vs-return-await/)